<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    ğŸ’¤ISpiker
</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta name="author" content="ğŸ’¤ISpiker">
<meta name="description" content="The proof is in the pudding.">
<meta name="keywords" content="The proof is in the pudding.">
<link rel="stylesheet" href="https://hehelv.github.io//media/css/main.css" />
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
<script src="https://hehelv.github.io//media/script/tocbot.min.js"></script>
<script src="https://hehelv.github.io//media/script/script.js"></script>
<!--<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>-->
<script src="https://cdn.bootcss.com/highlight.js/9.13.1/highlight.min.js"></script>
<link href="https://cdn.bootcss.com/highlight.js/9.13.1/styles/atelier-estuary-dark.min.css" rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://hehelv.github.io/">
                    ğŸ’¤ISpiker
                </a>
            </div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        Home
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        Archives
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        Tags
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        About
                    </a>
                    
                    <a class="menu-item" href="/tag/algorithm">
                        Algorithm
                    </a>
                    
                    <a class="menu-item" href="/tag/networking">
                        Computer Networking
                    </a>
                    
                    <a class="menu-item" href="/tag/Spider Note">
                        Spider Note
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://hehelv.github.io/">
                            ğŸ’¤ISpiker
                        </a>
                        <a id="mobile-toggle-theme">&nbsp;Light</a>
                    </div>
                    <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            Home
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            Archives
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            Tags
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            About
                        </a>
                        
                        <a class="menu-item" href="/tag/algorithm">
                            Algorithm
                        </a>
                        
                        <a class="menu-item" href="/tag/networking">
                            Computer Networking
                        </a>
                        
                        <a class="menu-item" href="/tag/Spider Note">
                            Spider Note
                        </a>
                        
                </div>
            </div>
        </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                12-å¤šçº¿ç¨‹çˆ¬è™«
                            </h1>
                            <div class="post-meta">
                                Author:
                                <a itemprop="author" rel="author" href="/">
                                    ğŸ’¤ISpiker
                                </a>
                                <span class="post-time">
                                Date: <a href="#">2020-03-03</a>
                            </span>
                                
                                    <span class="post-category">
                                Category:
                                
                                <a href="https://hehelv.github.io//tag/Spider Note">Pythonçˆ¬è™«ç¬”è®°</a>
                                
                            </span>
                                    
                            </div>
                        </header>

                        <div class="post-content">
                            <h1 id="12-å¤šçº¿ç¨‹çˆ¬è™«">12-å¤šçº¿ç¨‹çˆ¬è™«</h1>
<p>æœ‰äº›æ—¶å€™ï¼Œæ¯”å¦‚ä¸‹è½½å›¾ç‰‡ï¼Œå› ä¸ºä¸‹è½½å›¾ç‰‡æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œã€‚å¦‚æœé‡‡ç”¨ä¹‹å‰é‚£ç§åŒæ­¥çš„æ–¹å¼ä¸‹è½½ã€‚é‚£æ•ˆç‡è‚¯ä¼šç‰¹åˆ«æ…¢ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ¥ä¸‹è½½å›¾ç‰‡ã€‚</p>
<h2 id="å¤šçº¿ç¨‹ä»‹ç»">å¤šçº¿ç¨‹ä»‹ç»ï¼š</h2>
<p>å¤šçº¿ç¨‹æ˜¯ä¸ºäº†åŒæ­¥å®Œæˆå¤šé¡¹ä»»åŠ¡ï¼Œé€šè¿‡æé«˜èµ„æºä½¿ç”¨æ•ˆç‡æ¥æé«˜ç³»ç»Ÿçš„æ•ˆç‡ã€‚çº¿ç¨‹æ˜¯åœ¨åŒä¸€æ—¶é—´éœ€è¦å®Œæˆå¤šé¡¹ä»»åŠ¡çš„æ—¶å€™å®ç°çš„ã€‚<br>
æœ€ç®€å•çš„æ¯”å–»å¤šçº¿ç¨‹å°±åƒç«è½¦çš„æ¯ä¸€èŠ‚è½¦å¢ï¼Œè€Œè¿›ç¨‹åˆ™æ˜¯ç«è½¦ã€‚è½¦å¢ç¦»å¼€ç«è½¦æ˜¯æ— æ³•è·‘åŠ¨çš„ï¼ŒåŒç†ç«è½¦ä¹Ÿå¯ä»¥æœ‰å¤šèŠ‚è½¦å¢ã€‚å¤šçº¿ç¨‹çš„å‡ºç°å°±æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ã€‚åŒæ—¶å®ƒçš„å‡ºç°ä¹Ÿå¸¦æ¥äº†ä¸€äº›é—®é¢˜ã€‚æ›´å¤šä»‹ç»è¯·å‚è€ƒï¼šhttps://baike.baidu.com/item/å¤šçº¿ç¨‹/1190404?fr=aladdin</p>
<h2 id="threadingæ¨¡å—ä»‹ç»">threadingæ¨¡å—ä»‹ç»ï¼š</h2>
<p><code>threading</code>æ¨¡å—æ˜¯<code>python</code>ä¸­ä¸“é—¨æä¾›ç”¨æ¥åšå¤šçº¿ç¨‹ç¼–ç¨‹çš„æ¨¡å—ã€‚<code>threading</code>æ¨¡å—ä¸­æœ€å¸¸ç”¨çš„ç±»æ˜¯<code>Thread</code>ã€‚ä»¥ä¸‹çœ‹ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹ç¨‹åºï¼š</p>
<pre><code class="language-python">import threading
import time

def coding():
    for x in range(3):
        print('%sæ­£åœ¨å†™ä»£ç ' % x)
        time.sleep(1)

def drawing():
    for x in range(3):
        print('%sæ­£åœ¨ç”»å›¾' % x)
        time.sleep(1)


def single_thread():
    coding()
    drawing()

def multi_thread():
    t1 = threading.Thread(target=coding)
    t2 = threading.Thread(target=drawing)

    t1.start()
    t2.start()

if __name__ == '__main__':
    multi_thread()
</code></pre>
<h3 id="æŸ¥çœ‹çº¿ç¨‹æ•°">æŸ¥çœ‹çº¿ç¨‹æ•°ï¼š</h3>
<p>ä½¿ç”¨<code>threading.enumerate()</code>å‡½æ•°ä¾¿å¯ä»¥çœ‹åˆ°å½“å‰çº¿ç¨‹çš„æ•°é‡ã€‚</p>
<h3 id="æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„åå­—">æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„åå­—ï¼š</h3>
<p>ä½¿ç”¨<code>threading.current_thread()</code>å¯ä»¥çœ‹åˆ°å½“å‰çº¿ç¨‹çš„ä¿¡æ¯ã€‚</p>
<h3 id="ç»§æ‰¿è‡ªthreadingthreadç±»">ç»§æ‰¿è‡ª<code>threading.Thread</code>ç±»ï¼š</h3>
<p>ä¸ºäº†è®©çº¿ç¨‹ä»£ç æ›´å¥½çš„å°è£…ã€‚å¯ä»¥ä½¿ç”¨<code>threading</code>æ¨¡å—ä¸‹çš„<code>Thread</code>ç±»ï¼Œç»§æ‰¿è‡ªè¿™ä¸ªç±»ï¼Œç„¶åå®ç°<code>run</code>æ–¹æ³•ï¼Œçº¿ç¨‹å°±ä¼šè‡ªåŠ¨è¿è¡Œ<code>run</code>æ–¹æ³•ä¸­çš„ä»£ç ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">import threading
import time

class CodingThread(threading.Thread):
    def run(self):
        for x in range(3):
            print('%sæ­£åœ¨å†™ä»£ç ' % threading.current_thread())
            time.sleep(1)

class DrawingThread(threading.Thread):
    def run(self):
        for x in range(3):
            print('%sæ­£åœ¨ç”»å›¾' % threading.current_thread())
            time.sleep(1)

def multi_thread():
    t1 = CodingThread()
    t2 = DrawingThread()

    t1.start()
    t2.start()

if __name__ == '__main__':
    multi_thread()
</code></pre>
<h3 id="å¤šçº¿ç¨‹å…±äº«å…¨å±€å˜é‡çš„é—®é¢˜">å¤šçº¿ç¨‹å…±äº«å…¨å±€å˜é‡çš„é—®é¢˜ï¼š</h3>
<p>å¤šçº¿ç¨‹éƒ½æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œçš„ã€‚å› æ­¤åœ¨è¿›ç¨‹ä¸­çš„å…¨å±€å˜é‡æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å¯å…±äº«çš„ã€‚è¿™å°±é€ æˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹æ‰§è¡Œçš„é¡ºåºæ˜¯æ— åºçš„ã€‚æœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®é”™è¯¯ã€‚æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-python">import threading

tickets = 0

def get_ticket():
    global tickets
    for x in range(1000000):
        tickets += 1
    print('tickets:%d'%tickets)

def main():
    for x in range(2):
        t = threading.Thread(target=get_ticket)
        t.start()

if __name__ == '__main__':
    main()
</code></pre>
<p>ä»¥ä¸Šç»“æœæ­£å¸¸æ¥è®²åº”è¯¥æ˜¯6ï¼Œä½†æ˜¯å› ä¸ºå¤šçº¿ç¨‹è¿è¡Œçš„ä¸ç¡®å®šæ€§ã€‚å› æ­¤æœ€åçš„ç»“æœå¯èƒ½æ˜¯éšæœºçš„ã€‚</p>
<h3 id="é”æœºåˆ¶">é”æœºåˆ¶ï¼š</h3>
<p>ä¸ºäº†è§£å†³ä»¥ä¸Šä½¿ç”¨å…±äº«å…¨å±€å˜é‡çš„é—®é¢˜ã€‚<code>threading</code>æä¾›äº†ä¸€ä¸ª<code>Lock</code>ç±»ï¼Œè¿™ä¸ªç±»å¯ä»¥åœ¨æŸä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªå˜é‡çš„æ—¶å€™åŠ é”ï¼Œå…¶ä»–çº¿ç¨‹æ­¤æ—¶å°±ä¸èƒ½è¿›æ¥ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹å¤„ç†å®Œåï¼ŒæŠŠé”é‡Šæ”¾äº†ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è¿›æ¥å¤„ç†ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">import threading

VALUE = 0

gLock = threading.Lock()

def add_value():
    global VALUE
    gLock.acquire()
    for x in range(1000000):
        VALUE += 1
    gLock.release()
    print('valueï¼š%d'%VALUE)

def main():
    for x in range(2):
        t = threading.Thread(target=add_value)
        t.start()

if __name__ == '__main__':
    main()
</code></pre>
<h2 id="lockç‰ˆæœ¬ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼">Lockç‰ˆæœ¬ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ï¼š</h2>
<p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼æ˜¯å¤šçº¿ç¨‹å¼€å‘ä¸­ç»å¸¸è§åˆ°çš„ä¸€ç§æ¨¡å¼ã€‚ç”Ÿäº§è€…çš„çº¿ç¨‹ä¸“é—¨ç”¨æ¥ç”Ÿäº§ä¸€äº›æ•°æ®ï¼Œç„¶åå­˜æ”¾åˆ°ä¸€ä¸ªä¸­é—´çš„å˜é‡ä¸­ã€‚æ¶ˆè´¹è€…å†ä»è¿™ä¸ªä¸­é—´çš„å˜é‡ä¸­å–å‡ºæ•°æ®è¿›è¡Œæ¶ˆè´¹ã€‚ä½†æ˜¯å› ä¸ºè¦ä½¿ç”¨ä¸­é—´å˜é‡ï¼Œä¸­é—´å˜é‡ç»å¸¸æ˜¯ä¸€äº›å…¨å±€å˜é‡ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨é”æ¥ä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨<code>threading.Lock</code>é”å®ç°çš„â€œç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼â€çš„ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-python">import threading
import random
import time

gMoney = 1000
gLock = threading.Lock()
# è®°å½•ç”Ÿäº§è€…ç”Ÿäº§çš„æ¬¡æ•°ï¼Œè¾¾åˆ°10æ¬¡å°±ä¸å†ç”Ÿäº§
gTimes = 0

class Producer(threading.Thread):
    def run(self):
        global gMoney
        global gLock
        global gTimes
        while True:
            money = random.randint(100, 1000)
            gLock.acquire()
            # å¦‚æœå·²ç»è¾¾åˆ°10æ¬¡äº†ï¼Œå°±ä¸å†ç”Ÿäº§äº†
            if gTimes &gt;= 10:
                gLock.release()
                break
            gMoney += money
            print('%så½“å‰å­˜å…¥%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±' % (threading.current_thread(), money, gMoney))
            gTimes += 1
            time.sleep(0.5)
            gLock.release()

class Consumer(threading.Thread):
    def run(self):
        global gMoney
        global gLock
        global gTimes
        while True:
            money = random.randint(100, 500)
            gLock.acquire()
            if gMoney &gt; money:
                gMoney -= money
                print('%så½“å‰å–å‡º%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±' % (threading.current_thread(), money, gMoney))
                time.sleep(0.5)
            else:
                # å¦‚æœé’±ä¸å¤Ÿäº†ï¼Œæœ‰å¯èƒ½æ˜¯å·²ç»è¶…è¿‡äº†æ¬¡æ•°ï¼Œè¿™æ—¶å€™å°±åˆ¤æ–­ä¸€ä¸‹
                if gTimes &gt;= 10:
                    gLock.release()
                    break
                print(&quot;%så½“å‰æƒ³å–%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±ï¼Œä¸è¶³ï¼&quot; % (threading.current_thread(),money,gMoney))
            gLock.release()

def main():
    for x in range(5):
        Consumer(name='æ¶ˆè´¹è€…çº¿ç¨‹%d'%x).start()

    for x in range(5):
        Producer(name='ç”Ÿäº§è€…çº¿ç¨‹%d'%x).start()

if __name__ == '__main__':
    main()
</code></pre>
<h2 id="conditionç‰ˆçš„ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼">Conditionç‰ˆçš„ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼ï¼š</h2>
<p><code>Lock</code>ç‰ˆæœ¬çš„ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼å¯ä»¥æ­£å¸¸çš„è¿è¡Œã€‚ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªä¸è¶³ï¼Œåœ¨æ¶ˆè´¹è€…ä¸­ï¼Œæ€»æ˜¯é€šè¿‡<code>while True</code>æ­»å¾ªç¯å¹¶ä¸”ä¸Šé”çš„æ–¹å¼å»åˆ¤æ–­é’±å¤Ÿä¸å¤Ÿã€‚ä¸Šé”æ˜¯ä¸€ä¸ªå¾ˆè€—è´¹CPUèµ„æºçš„è¡Œä¸ºã€‚å› æ­¤è¿™ç§æ–¹å¼ä¸æ˜¯æœ€å¥½çš„ã€‚è¿˜æœ‰ä¸€ç§æ›´å¥½çš„æ–¹å¼ä¾¿æ˜¯ä½¿ç”¨<code>threading.Condition</code>æ¥å®ç°ã€‚<code>threading.Condition</code>å¯ä»¥åœ¨æ²¡æœ‰æ•°æ®çš„æ—¶å€™å¤„äºé˜»å¡ç­‰å¾…çŠ¶æ€ã€‚ä¸€æ—¦æœ‰åˆé€‚çš„æ•°æ®äº†ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>notify</code>ç›¸å…³çš„å‡½æ•°æ¥é€šçŸ¥å…¶ä»–å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚è¿™æ ·å°±å¯ä»¥ä¸ç”¨åšä¸€äº›æ— ç”¨çš„ä¸Šé”å’Œè§£é”çš„æ“ä½œã€‚å¯ä»¥æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚é¦–å…ˆå¯¹<code>threading.Condition</code>ç›¸å…³çš„å‡½æ•°åšä¸ªä»‹ç»ï¼Œ<code>threading.Condition</code>ç±»ä¼¼<code>threading.Lock</code>ï¼Œå¯ä»¥åœ¨ä¿®æ”¹å…¨å±€æ•°æ®çš„æ—¶å€™è¿›è¡Œä¸Šé”ï¼Œä¹Ÿå¯ä»¥åœ¨ä¿®æ”¹å®Œæ¯•åè¿›è¡Œè§£é”ã€‚ä»¥ä¸‹å°†ä¸€äº›å¸¸ç”¨çš„å‡½æ•°åšä¸ªç®€å•çš„ä»‹ç»ï¼š</p>
<ol>
<li><code>acquire</code>ï¼šä¸Šé”ã€‚</li>
<li><code>release</code>ï¼šè§£é”ã€‚</li>
<li><code>wait</code>ï¼šå°†å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šé‡Šæ”¾é”ã€‚å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨<code>notify</code>å’Œ<code>notify_all</code>å‡½æ•°å”¤é†’ã€‚è¢«å”¤é†’åä¼šç»§ç»­ç­‰å¾…ä¸Šé”ï¼Œä¸Šé”åç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚</li>
<li><code>notify</code>ï¼šé€šçŸ¥æŸä¸ªæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ï¼Œé»˜è®¤æ˜¯ç¬¬1ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚</li>
<li><code>notify_all</code>ï¼šé€šçŸ¥æ‰€æœ‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚<code>notify</code>å’Œ<code>notify_all</code>ä¸ä¼šé‡Šæ”¾é”ã€‚å¹¶ä¸”éœ€è¦åœ¨<code>release</code>ä¹‹å‰è°ƒç”¨ã€‚</li>
</ol>
<p><code>Condition</code>ç‰ˆçš„ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">import threading
import random
import time

gMoney = 1000
gCondition = threading.Condition()
gTimes = 0
gTotalTimes = 5

class Producer(threading.Thread):
    def run(self):
        global gMoney
        global gCondition
        global gTimes
        while True:
            money = random.randint(100, 1000)
            gCondition.acquire()
            if gTimes &gt;= gTotalTimes:
                gCondition.release()
                print('å½“å‰ç”Ÿäº§è€…æ€»å…±ç”Ÿäº§äº†%sæ¬¡'%gTimes)
                break
            gMoney += money
            print('%så½“å‰å­˜å…¥%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±' % (threading.current_thread(), money, gMoney))
            gTimes += 1
            time.sleep(0.5)
            gCondition.notify_all()
            gCondition.release()

class Consumer(threading.Thread):
    def run(self):
        global gMoney
        global gCondition
        while True:
            money = random.randint(100, 500)
            gCondition.acquire()
            # è¿™é‡Œè¦ç»™ä¸ªwhileå¾ªç¯åˆ¤æ–­ï¼Œå› ä¸ºç­‰è½®åˆ°è¿™ä¸ªçº¿ç¨‹çš„æ—¶å€™
            # æ¡ä»¶æœ‰å¯èƒ½åˆä¸æ»¡è¶³äº†
            while gMoney &lt; money:
                if gTimes &gt;= gTotalTimes:
                    gCondition.release()
                    return
                print('%så‡†å¤‡å–%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±ï¼Œä¸è¶³ï¼'%(threading.current_thread(),money,gMoney))
                gCondition.wait()
            gMoney -= money
            print('%så½“å‰å–å‡º%så…ƒé’±ï¼Œå‰©ä½™%så…ƒé’±' % (threading.current_thread(), money, gMoney))
            time.sleep(0.5)
            gCondition.release()

def main():
    for x in range(5):
        Consumer(name='æ¶ˆè´¹è€…çº¿ç¨‹%d'%x).start()

    for x in range(2):
        Producer(name='ç”Ÿäº§è€…çº¿ç¨‹%d'%x).start()

if __name__ == '__main__':
    main()
</code></pre>
<h2 id="queueçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—">Queueçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼š</h2>
<p>åœ¨çº¿ç¨‹ä¸­ï¼Œè®¿é—®ä¸€äº›å…¨å±€å˜é‡ï¼ŒåŠ é”æ˜¯ä¸€ä¸ªç»å¸¸çš„è¿‡ç¨‹ã€‚å¦‚æœä½ æ˜¯æƒ³æŠŠä¸€äº›æ•°æ®å­˜å‚¨åˆ°æŸä¸ªé˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆPythonå†…ç½®äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ¨¡å—å«åš<code>queue</code>æ¨¡å—ã€‚Pythonä¸­çš„queueæ¨¡å—ä¸­æä¾›äº†åŒæ­¥çš„ã€çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ç±»ï¼ŒåŒ…æ‹¬FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—Queueï¼ŒLIFOï¼ˆåå…¥å…ˆå‡ºï¼‰é˜Ÿåˆ—LifoQueueã€‚è¿™äº›é˜Ÿåˆ—éƒ½å®ç°äº†é”åŸè¯­ï¼ˆå¯ä»¥ç†è§£ä¸ºåŸå­æ“ä½œï¼Œå³è¦ä¹ˆä¸åšï¼Œè¦ä¹ˆéƒ½åšå®Œï¼‰ï¼Œèƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ä¸­ç›´æ¥ä½¿ç”¨ã€‚å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹é—´çš„åŒæ­¥ã€‚ç›¸å…³çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆå§‹åŒ–Queue(maxsize)ï¼šåˆ›å»ºä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ã€‚</li>
<li>qsize()ï¼šè¿”å›é˜Ÿåˆ—çš„å¤§å°ã€‚</li>
<li>empty()ï¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚</li>
<li>full()ï¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ã€‚</li>
<li>get()ï¼šä»é˜Ÿåˆ—ä¸­å–æœ€åä¸€ä¸ªæ•°æ®ã€‚</li>
<li>put()ï¼šå°†ä¸€ä¸ªæ•°æ®æ”¾åˆ°é˜Ÿåˆ—ä¸­ã€‚</li>
</ol>
<h2 id="ä½¿ç”¨ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼å¤šçº¿ç¨‹ä¸‹è½½è¡¨æƒ…åŒ…">ä½¿ç”¨ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼å¤šçº¿ç¨‹ä¸‹è½½è¡¨æƒ…åŒ…ï¼š</h2>
<pre><code class="language-python">import threading
import requests
from lxml import etree
from urllib import request
import os
import re
from queue import Queue

class Producer(threading.Thread):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36'
    }
    def __init__(self,page_queue,img_queue,*args,**kwargs):
        super(Producer, self).__init__(*args,**kwargs)
        self.page_queue = page_queue
        self.img_queue = img_queue


    def run(self):
        while True:
            if self.page_queue.empty():
                break
            url = self.page_queue.get()
            self.parse_page(url)

    def parse_page(self,url):
        response = requests.get(url,headers=self.headers)
        text = response.text
        html = etree.HTML(text)
        imgs = html.xpath(&quot;//div[@class='page-content text-center']//a//img&quot;)
        for img in imgs:
            if img.get('class') == 'gif':
                continue
            img_url = img.xpath(&quot;.//@data-original&quot;)[0]
            suffix = os.path.splitext(img_url)[1]
            alt = img.xpath(&quot;.//@alt&quot;)[0]
            alt = re.sub(r'[ï¼Œã€‚ï¼Ÿ?,/\\Â·]','',alt)
            img_name = alt + suffix
            self.img_queue.put((img_url,img_name))

class Consumer(threading.Thread):
    def __init__(self,page_queue,img_queue,*args,**kwargs):
        super(Consumer, self).__init__(*args,**kwargs)
        self.page_queue = page_queue
        self.img_queue = img_queue

    def run(self):
        while True:
            if self.img_queue.empty():
                if self.page_queue.empty():
                    return
            img = self.img_queue.get(block=True)
            url,filename = img
            request.urlretrieve(url,'images/'+filename)
            print(filename+'  ä¸‹è½½å®Œæˆï¼')

def main():
    page_queue = Queue(100)
    img_queue = Queue(500)
    for x in range(1,101):
        url = &quot;http://www.doutula.com/photo/list/?page=%d&quot; % x
        page_queue.put(url)

    for x in range(5):
        t = Producer(page_queue,img_queue)
        t.start()

    for x in range(5):
        t = Consumer(page_queue,img_queue)
        t.start()

if __name__ == '__main__':
    main()
</code></pre>
<h2 id="gilå…¨å±€è§£é‡Šå™¨é”">GILå…¨å±€è§£é‡Šå™¨é”ï¼š</h2>
<p>Pythonè‡ªå¸¦çš„è§£é‡Šå™¨æ˜¯<code>CPython</code>ã€‚<code>CPython</code>è§£é‡Šå™¨çš„å¤šçº¿ç¨‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡çš„å¤šçº¿ç¨‹ï¼ˆåœ¨å¤šæ ¸CPUä¸­ï¼Œåªèƒ½åˆ©ç”¨ä¸€æ ¸ï¼Œä¸èƒ½åˆ©ç”¨å¤šæ ¸ï¼‰ã€‚åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œä¸ºäº†ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œåœ¨<code>CPython</code>è§£é‡Šå™¨ä¸­æœ‰ä¸€ä¸ªä¸œè¥¿å«åš<code>GILï¼ˆGlobal Intepreter Lockï¼‰</code>ï¼Œå«åšå…¨å±€è§£é‡Šå™¨é”ã€‚è¿™ä¸ªè§£é‡Šå™¨é”æ˜¯æœ‰å¿…è¦çš„ã€‚å› ä¸º<code>CPython</code>è§£é‡Šå™¨çš„å†…å­˜ç®¡ç†ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“ç„¶é™¤äº†<code>CPython</code>è§£é‡Šå™¨ï¼Œè¿˜æœ‰å…¶ä»–çš„è§£é‡Šå™¨ï¼Œæœ‰äº›è§£é‡Šå™¨æ˜¯æ²¡æœ‰<code>GIL</code>é”çš„ï¼Œè§ä¸‹é¢ï¼š</p>
<ol>
<li><code>Jython</code>ï¼šç”¨Javaå®ç°çš„Pythonè§£é‡Šå™¨ã€‚ä¸å­˜åœ¨GILé”ã€‚æ›´å¤šè¯¦æƒ…è¯·è§ï¼šhttps://zh.wikipedia.org/wiki/Jython</li>
<li><code>IronPython</code>ï¼šç”¨<code>.net</code>å®ç°çš„Pythonè§£é‡Šå™¨ã€‚ä¸å­˜åœ¨GILé”ã€‚æ›´å¤šè¯¦æƒ…è¯·è§ï¼šhttps://zh.wikipedia.org/wiki/IronPython</li>
<li><code>PyPy</code>ï¼šç”¨<code>Python</code>å®ç°çš„Pythonè§£é‡Šå™¨ã€‚å­˜åœ¨GILé”ã€‚æ›´å¤šè¯¦æƒ…è¯·è§ï¼šhttps://zh.wikipedia.org/wiki/PyPy<br>
GILè™½ç„¶æ˜¯ä¸€ä¸ªå‡çš„å¤šçº¿ç¨‹ã€‚ä½†æ˜¯åœ¨å¤„ç†ä¸€äº›IOæ“ä½œï¼ˆæ¯”å¦‚æ–‡ä»¶è¯»å†™å’Œç½‘ç»œè¯·æ±‚ï¼‰è¿˜æ˜¯å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜æ•ˆç‡çš„ã€‚åœ¨IOæ“ä½œä¸Šå»ºè®®ä½¿ç”¨å¤šçº¿ç¨‹æé«˜æ•ˆç‡ã€‚åœ¨ä¸€äº›CPUè®¡ç®—æ“ä½œä¸Šä¸å»ºè®®ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œè€Œå»ºè®®ä½¿ç”¨å¤šè¿›ç¨‹ã€‚</li>
</ol>
<h2 id="å¤šçº¿ç¨‹ä¸‹è½½ç™¾æ€ä¸å¾—å§æ®µå­ä½œä¸š">å¤šçº¿ç¨‹ä¸‹è½½ç™¾æ€ä¸å¾—å§æ®µå­ä½œä¸šï¼š</h2>
<pre><code class="language-python">import requests
from lxml import etree
import threading
from queue import Queue
import csv


class BSSpider(threading.Thread):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36'
    }
    def __init__(self,page_queue,joke_queue,*args,**kwargs):
        super(BSSpider, self).__init__(*args,**kwargs)
        self.base_domain = 'http://www.budejie.com'
        self.page_queue = page_queue
        self.joke_queue = joke_queue

    def run(self):
        while True:
            if self.page_queue.empty():
                break
            url = self.page_queue.get()
            response = requests.get(url, headers=self.headers)
            text = response.text
            html = etree.HTML(text)
            descs = html.xpath(&quot;//div[@class='j-r-list-c-desc']&quot;)
            for desc in descs:
                jokes = desc.xpath(&quot;.//text()&quot;)
                joke = &quot;\n&quot;.join(jokes).strip()
                link = self.base_domain+desc.xpath(&quot;.//a/@href&quot;)[0]
                self.joke_queue.put((joke,link))
            print('='*30+&quot;ç¬¬%sé¡µä¸‹è½½å®Œæˆï¼&quot;%url.split('/')[-1]+&quot;=&quot;*30)

class BSWriter(threading.Thread):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36'
    }

    def __init__(self, joke_queue, writer,gLock, *args, **kwargs):
        super(BSWriter, self).__init__(*args, **kwargs)
        self.joke_queue = joke_queue
        self.writer = writer
        self.lock = gLock

    def run(self):
        while True:
            try:
                joke_info = self.joke_queue.get(timeout=40)
                joke,link = joke_info
                self.lock.acquire()
                self.writer.writerow((joke,link))
                self.lock.release()
                print('ä¿å­˜ä¸€æ¡')
            except:
                break

def main():
    page_queue = Queue(10)
    joke_queue = Queue(500)
    gLock = threading.Lock()
    fp = open('bsbdj.csv', 'a',newline='', encoding='utf-8')
    writer = csv.writer(fp)
    writer.writerow(('content', 'link'))

    for x in range(1,11):
        url = 'http://www.budejie.com/text/%d' % x
        page_queue.put(url)

    for x in range(5):
        t = BSSpider(page_queue,joke_queue)
        t.start()

    for x in range(5):
        t = BSWriter(joke_queue,writer,gLock)
        t.start()

if __name__ == '__main__':
    main()
</code></pre>

                        </div>
                        <section class="post-copyright">

                            <p class="copyright-item">
                                <span>Author:</span>
                                <span>ğŸ’¤ISpiker</span>
                            </p>

                            <p class="copyright-item">
                                <span>Permalink:</span>
                                <span><a href="https://hehelv.github.io//post/1-duo-xian-cheng-pa-chong">https://hehelv.github.io//post/1-duo-xian-cheng-pa-chong</a></span>
                            </p>

                            <p class="copyright-item">
                                <span>License:</span>
                                <span>MIT License</span>
                            </p>

                        </section>
                        <section class="post-tags">
                            <div>
                                <span>Tag(s):</span>
                                <span class="tag">
                                
                                
                                <a href="https://hehelv.github.io//tag/Spider Note"># Pythonçˆ¬è™«ç¬”è®°</a>
                                
                                
                            </span>
                            </div>
                            <div>
                                <a href="javascript:window.history.back();">back</a>
                                <span>Â·</span>
                                <a href="#">home</a>
                            </div>
                        </section>
                        <section class="post-nav">
                            
                                <a class="prev" rel="prev" href="https://hehelv.github.io//post/13-dong-tai-wang-ye-pa-chong">
                                    13-åŠ¨æ€ç½‘é¡µçˆ¬è™«
                                </a>
                                
                                    
                                        <a class="next" rel="next" href="https://hehelv.github.io//post/11-mongodb-shu-ju-ku">
                                            11-MongoDBæ•°æ®åº“
                                        </a>
                                        
                        </section>

                    </article>
                </div>
                
            </div>
    </div>
    </div>

    </div>
    <footer id="footer" class="footer">
    <div class="copyright">
        

            <script>
                var xhr = new XMLHttpRequest();
                xhr.open('get', 'https://v1.hitokoto.cn');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        var data = JSON.parse(xhr.responseText);
                        var hitokoto = document.getElementById('hitokoto');
                        hitokoto.innerText = data.hitokoto;
                    }
                }
                xhr.send();
                (function() {
                    var bp = document.createElement('script');
                    var curProtocol = window.location.protocol.split(':')[0];
                    if (curProtocol === 'https') {
                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                    } else {
                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                    }
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(bp, s);
                })();
            </script>
            <b id="hitokoto"></b><br>
            <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face"><path d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z" fill="#93b5cf"></path></svg>
            <script>
                var date = new Date();
                document.write(" " + date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥" + " æ˜ŸæœŸ" + "æ—¥ä¸€äºŒä¸‰å››äº”å…­".charAt(date.getDay()));
            </script> Copyright&copy;
            ğŸ’¤ISpiker | Powered by <a href="https://coding.net" target="_blank">Coding.net</a>

    </div>
</footer>
<script>
    hljs.initHighlighting();
</script>
        </div>
</body>

</html>